<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quiz</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <button onclick="goBack()" class="back-btn">‚Üê Back</button>

    <h1 id="quiz-title">Quiz</h1>

    <div id="quiz-box">
      <p id="question-text"></p>
      <div id="options"></div>

      <button id="next-btn" style="display:none;">Next Question</button>
      <button id="finish-btn" style="display:none;">Finish Quiz</button>
    </div>

    <div id="result-box" style="display:none;">
      <h2>Your Score</h2>
      <p id="score-text"></p>
      <button onclick="goBack()">Back to Lesson</button>
    </div>

    <div id="error-box" style="display:none; margin-top:20px;">
      <h2>Error</h2>
      <p id="error-text"></p>
    </div>
  </div>

  <!-- LOAD QUIZ DATA -->
  <script src="assets/quiz-data.js"></script>

  <script>
    // -----------------------------
    // SAFETY CHECKS
    // -----------------------------
    function showError(msg) {
      document.getElementById("quiz-box").style.display = "none";
      document.getElementById("result-box").style.display = "none";

      const box = document.getElementById("error-box");
      document.getElementById("error-text").innerText = msg;
      box.style.display = "block";
    }

    // -----------------------------
    // GET LESSON ID FROM URL
    // -----------------------------
    const params = new URLSearchParams(window.location.search);
    const lessonId = params.get("lesson");

    if (!lessonId) {
      showError("No lesson was provided. The quiz cannot load.");
      throw new Error("Missing lesson ID");
    }

    // -----------------------------
    // DETERMINE TRACK NAME
    // -----------------------------
    const track = lessonId.split("-")[0];

    if (!track) {
      showError("Invalid lesson format. Expected something like 'foundations-1'.");
      throw new Error("Invalid lesson ID format");
    }

    // -----------------------------
    // LOAD QUIZ DATA FOR TRACK
    // -----------------------------
    if (typeof QUIZZES === "undefined") {
      showError("Quiz data file (quiz-data.js) did not load.");
      throw new Error("QUIZZES is undefined");
    }

    const quiz = QUIZZES[track];

    if (!quiz) {
      showError(`No quiz found for track: "${track}". Check quiz-data.js.`);
      throw new Error("Quiz not found for track");
    }

    if (!Array.isArray(quiz) || quiz.length === 0) {
      showError(`Quiz for track "${track}" is empty.`);
      throw new Error("Quiz array empty");
    }

    // -----------------------------
    // QUIZ ENGINE
    // -----------------------------
    let current = 0;
    let score = 0;

    document.getElementById("quiz-title").innerText =
      "Quiz: " + track.charAt(0).toUpperCase() + track.slice(1);

    function loadQuestion() {
      const q = quiz[current];

      if (!q || !q.q) {
        showError("A quiz question is missing or incorrectly formatted.");
        return;
      }

      document.getElementById("question-text").innerText = q.q;

      const optionsBox = document.getElementById("options");
      optionsBox.innerHTML = "";

      q.options.forEach((opt, index) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.innerText = opt;
        btn.onclick = () => selectAnswer(index);
        optionsBox.appendChild(btn);
      });

      document.getElementById("next-btn").style.display = "none";
      document.getElementById("finish-btn").style.display = "none";
    }

    function selectAnswer(index) {
      const correct = quiz[current].correct;
      const buttons = document.querySelectorAll(".option-btn");

      buttons.forEach((btn, i) => {
        btn.disabled = true;
        if (i === correct) btn.classList.add("correct");
        if (i === index && index !== correct) btn.classList.add("wrong");
      });

      if (index === correct) score++;

      if (current < quiz.length - 1) {
        document.getElementById("next-btn").style.display = "block";
      } else {
        document.getElementById("finish-btn").style.display = "block";
      }
    }

    document.getElementById("next-btn").onclick = () => {
      current++;
      loadQuestion();
    };

    document.getElementById("finish-btn").onclick = () => {
      document.getElementById("quiz-box").style.display = "none";
      document.getElementById("result-box").style.display = "block";
      document.getElementById("score-text").innerText =
        `You scored ${score} out of ${quiz.length}.`;
    };

    function goBack() {
      window.history.back();
    }

    // Start quiz
    loadQuestion();
  </script>
</body>
</html>
